<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test midi-baby communication</title>
    <meta name="author" content="https://github.com/francoisgeorgy">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/moment/moment/03073778/moment.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@2.3.3"></script>
    <style>
        html {
            font-family: sans-serif;
        }
        .help {
            display: none;
        }
        #clear {
            float: right;
            font-size: 1em;
            margin-left: 10px;
        }
        .gray-box {
            border: 1px solid #aaa;
            background-color: #f0f0f0;
            padding: 1rem;
            margin: 1rem;
            text-align: left;
        }
        button {
            margin-left: 1rem;
            font-size: 1rem;
            color: #000;
        }
        #state, #messages, .data {
            font-family: monospace;
            white-space: pre;
        }
        .data {
            font-size: 1.15rem;
        }
        #send-messages  {
            display: grid;
            grid-template-columns: auto auto auto;
            justify-content: start;
            grid-column-gap: 10px;
            grid-row-gap: 5px;
        }
    </style>
</head>
<body>

    <button id="clear">clear</button>

    <h3>Webmidi events:</h3>
    <div id="state" class="gray-box"></div>

    <h3>Inputs (MIDI sources):</h3>
    <ul id="inputs" class="xgray-box"></ul>

    <h3>Outputs (MIDI targets):</h3>
    <ul id="outputs" class="xgray-box"></ul>

    <h3>Send message:</h3>
    <div id="send-messages">
        <div><button id="send-read-id">send</button></div>
        <div>Read ID:</div>
        <div class="data">F0 7E 00 06 01 F7</div>
        <div><button id="send-read-global">send</button></div>
        <div>Read global config:</div>
        <div class="data">F0 00 02 17 1D F7</div>
        <div><button id="send-read-button-0">send</button></div>
        <div>Read button 0:</div>
        <div class="data">F0 00 02 17 1C 00 F7</div>
        <div><button id="send-read-preset-0">send</button></div>
        <div>Read preset 0:</div>
        <div class="data">F0 00 02 17 1F 00 00 F7</div>
    </div>

    <h3>MIDI messages:</h3>
    <div class="help">
        <p>Show the messages events generated by the <code>inputs</code> ports of the <code>WebMidi</code> object.</p>
    </div>
    <div id="messages" class="gray-box"></div>

    <script>

        function outputByName(name) {
            // return WebMidi.outputs.find(item => item.name === name);
            // var output = midiAccess.outputs.get(portID);

            for (let output of W3CMidi.outputs.values()) {
                if (output.name === name) {
                    return output;
                }
            }

            // iter = W3CMidi.outputs.values();
            // for (let o = iter.next(); !o.done; o = iter.next()) {
            //     let i = o.value;
            //     list("name: " + i.name + " - id " + i.id + " - connection state " + i.connection, "#outputs")
            // }

            return null;
        }

        function padZero(str, len, char) {
            let s = "";
            let c = char || "0";
            let n = (len || 2) - str.length;
            while (s.length < n) s += c;
            return s + str;
        }

        function h(v) {
            return (v === null || v === undefined) ? "" : padZero(v.toString(16).toUpperCase(), 2);
        }

        function hs(data) {
            return (data === null || data === undefined) ? "" : (Array.from(data).map(n => h(n))).join(" ");    // Array.from() is necessary to get a non-typed array
        }

        function list(what, where, id) {
            var c = what.startsWith("(") ? "gray" : "";
            $(where).append("<li class=\"" + c + "\">" + what + "</li>\n");
        }

        function log(what, where) {
            console.log("log", what, where);
            var c = what.startsWith("(") ? "gray" : "";
            $(where).append("<span class=\"" + c + "\">[" + moment().format('HH:mm:ss.SSS') + "] " + what + "</span>\n");
        }

/*
        function connectionEventToString(event) {
            return `${event.port.name} : "${event.type}" event for ${event.port.type}, connection status is ${event.port.connection}`;
        }
*/

/*
        function inputMessageToString(message) {
            return `< ${message.target.name} : ${hs(message.data)}`;
        }

        function logMidiMessage(message) {
            if ((typeof event === 'undefined') || (event === null)) {
                console.warn("logMidiMessage: null or undefined message received");
                return;
            }
            log(inputMessageToString(message), '#messages');
        }
*/

        function logMidiMessageOut(bytes, id, sysex=false) {
            let s = hs(bytes);
            if (sysex) s = `F0 ${s} F7`;
            log(`> ${id} : ${s}`, '#messages');
        }

/*
        function listInputsAndOutputs() {
            console.log("listInputsAndOutputs", WebMidi.inputs, WebMidi.outputs)
            $("#inputs").html("");
            $("#outputs").html("");
            WebMidi.inputs.forEach(function(i) { list(i.name, "#inputs", i.id) });
            WebMidi.outputs.forEach(function(i) { list(i.name, "#outputs", i.id) });
        }
*/

        function listInputsAndOutputs() {

            console.log("listInputsAndOutputs");

            if (W3CMidi === null) {
                console.error("listInputsAndOutputs: W3CMidi is null");
                return;
            }

            $("#inputs").html("");
            $("#outputs").html("");

            let iter = W3CMidi.inputs.values();
            for (let o = iter.next(); !o.done; o = iter.next()) {
                let i = o.value;
                list("name: " + i.name + " - id " + i.id + " - connection state " + i.connection, "#inputs")
            }

            iter = W3CMidi.outputs.values();
            for (let o = iter.next(); !o.done; o = iter.next()) {
                let i = o.value;
                list("name: " + i.name + " - id " + i.id + " - connection state " + i.connection, "#outputs")
            }
        }

        function onMidiMessage(message) {
            console.log("onMidiMessage", message);
            if (message instanceof MIDIMessageEvent) {
                console.log("message is MIDIMessageEvent");
                let bytes = message.data;       // type is Uint8Array
                let channel = bytes[0] & 0x0F;  // MIDI channel
                let type = bytes[0] & 0xF0;     // MIDI event type
                let port = message.currentTarget;
                log(`< ${port.name} : ${hs(bytes)}`, "#messages");
                // log(message.type + " data: [" + hs(bytes) + "] channel: " + channel + " source: " + port.name, "#messages");
            } else {
                console.log("message is NOT MIDIMessageEvent");
                log('< ' + message.type + ' : ' + hs(message.data), "#messages");
            }
        }


/*
        // add a "midimessage" event listener to each input
        function addInputListeners() {
            WebMidi.inputs.forEach(function(i) {
                console.log(`${i.name} : add input listener`, i);
                if (!i.hasListener("midimessage", "all", logMidiMessage)) {
                    i.addListener("midimessage", "all", logMidiMessage);
                    console.log(`${i.name} : input listener added on all channels`, "#state");
                } else {
                    console.log(`${i.name} : input listener already added`);
                }
            });
        }

        function removeInputListeners() {
            WebMidi.inputs.forEach(function(i) {
                console.log(`${i.name} : remove input listener`, i);
                i.removeListener();
                console.log(`${i.name} input listeners removed for all channels`, "#state");
            });
        }
*/

/*
        function onConnectionEvent(event) {

            if ((typeof event === 'undefined') || (event === null)) {
                console.warn("logMidiEvent: null or undefined event received");
                return;
            }
            log(connectionEventToString(event), '#state');

            if (event.port.type === 'input') {
                if (event.type === "connected") {
                    addInputListeners();
                }
                if (event.type === "disconnected") {
                    removeInputListeners();
                }
            }

            listInputsAndOutputs();
        }
*/

        function sendMessage(bytes) {
            const output = outputByName("Disaster G3 MIDI");
            console.log("sendMessage", output, bytes);
            if (output) {
                logMidiMessageOut(bytes, output.name, true);

                // var output = midiAccess.outputs.get(portID);
                output.send(bytes);  //omitting the timestamp means send immediately.
                // output.send( [0x80, 60, 0x40], window.performance.now() + 1000.0 );

                // output.sendSysex(bytes[0], bytes.slice(1));  // use sendSysex to bypass the webmidijs internal checks.
            }
        }


        function onStateChange(event) {
            console.log("onStateChange", event);
            const p = event.port;
            log(`${event.port.name} : "${event.type}" event for ${p.type}, state is ${p.state}, connection status is ${event.port.connection}`, "#state");
            if (p.state === "connected") {
                // Handle the connection
                if (p.type === "input") {
                    if (!p.onmidimessage) {
                        log(p.name + ' : input listener added', "#state");
                        p.onmidimessage = onMidiMessage;
                        // log('-- "' + p.name + '" input listener added', "#state");
                        console.log(p.name + '" input listener added', "#state");
                    }
                }
            } else if (p.state === "disconnected") {
                // Handle the disconnection
                if (p.type === "input") {
                    if (p.onmidimessage) {
                        p.onmidimessage = null;
                        // log('-- "' + p.name + '" input listener removed', "#state");
                        console.log(p.name + '" input listener removed', "#state");
                    }
                }
            } else {
                // log("-- " + p.type + ' "' + p.name + '" is in an unknown state: ' + p.state , "#state");
                console.log(p.type + ' "' + p.name + '" is in an unknown state: ' + p.state , "#state");
            }
            listInputsAndOutputs();
        }

        function onMIDISuccess(midiAccess) {
            console.log("onMIDISuccess", midiAccess);
            log("Got access to MIDI", "#state");
            W3CMidi = midiAccess;
            W3CMidi.onstatechange = onStateChange;
            listInputsAndOutputs();
        }

        function onMIDIFailure(msg) {
            console.log("onMIDIFailure", msg);
            log("Failed to get MIDI access. " + msg, "#state");
        }

        $(function() {

            $("#clear").click(function(){
                $("#state, #messages").html("");
            });

            $("#send-read-id").click(function(){
                sendMessage([0xF0, 0x7E, 0x00, 0x06, 0x01, 0xF7]);
            });
            $("#send-read-global").click(function() {
                sendMessage([0x00, 0x02, 0x17, 0x1D]);
            });
            $("#send-read-button-0").click(function() {
                sendMessage([0x00, 0x02, 0x17, 0x1C, 0x00]);
            });
            $("#send-read-preset-0").click(function() {
                sendMessage([0x00, 0x02, 0x17, 0x1F, 0x00, 0x00]);
            });

            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);
            } else {
                log("ERROR: navigator.requestMIDIAccess not supported", "#state");
            }

/*
            WebMidi.enable(function (err) {
                if (err) {
                    console.warn("WebMidi could not be enabled", err);
                    log("ERROR: " + err.message, "#state");
                    return;
                }
                log("Got access to MIDI", "#state");
                WebMidi.addListener("connected", onConnectionEvent);
                WebMidi.addListener("disconnected", onConnectionEvent);
                listInputsAndOutputs();
            }, true);
*/

        });

    </script>
</body>
</html>
