<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>W3C Web MIDI events</title>
    <meta name="author" content="https://github.com/francoisgeorgy">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/moment/moment/03073778/moment.js"></script>
    <style>
        html {
            font-family: sans-serif;
        }
        #clear-all, #toggle-help {
            float: right;
            font-size: 1em;
            margin-left: 10px;
        }
        .gray-box {
            border: 1px solid #aaa;
            background-color: #f0f0f0;
            padding: 1rem;
            margin: 1rem;
            text-align: left;
        }
        #events, #state, #inputs, #outputs, #messages {
            font-family: monospace;
            white-space: pre;
        }
        .gray {
            color: #999;
        }
        .small {
            font-size: 0.8em;
        }
    </style>
</head>
<body>

    <button id="clear-all">clear all</button>
    <button id="toggle-help">toggle help</button>

    <h1>Web-MIDI events and messages with the W3C standard API</h1>

    <div class="small"><a href="https://github.com/francoisgeorgy/web-midi-events" target="_blank" rel="noopener">https://github.com/francoisgeorgy/web-midi-events</a></div>

    <div class="help">
        <p>The W3C Web-MIDI API is documented at <a href="https://webaudio.github.io/web-midi-api/" target="_blank" rel="noopener">https://webaudio.github.io/web-midi-api/</a>.</p>
    </div>

    <h3>Application log: (last message first)</h3>
    <p class="help">Informative messages showing what the application is doing.</p>
    <div id="state" class="gray-box"></div>

    <h3>MIDI state events: (last event first)</h3>
    <div class="help">
        <p>Show the events generated by the <code>onstatechange</code> handler of the web-midi instance.</p>
        <code>
            yourMidiAccessObject.onstatechange = onStateChangeHandler;
        </code>
    </div>
    <div id="events" class="gray-box"></div>

    <!--<h3>onMidiMessage: (last event first)</h3>-->
    <!--<div id="events" class="gray-box"></div>-->

    <h3>Inputs (MIDI sources):</h3>
    <p class="help">Show the MIDI ports given by <code>inputs.values()</code> of the web-midi instance.</p>
    <div id="inputs" class="gray-box"></div>

    <h3>Outputs (MIDI targets):</h3>
    <p class="help">Show the MIDI ports given by <code>outputs.values()</code> of the web-midi instance.</p>
    <div id="outputs" class="gray-box"></div>

    <h3>MIDI messages: (last message first)</h3>
    <div class="help">
        <p>Show the messages events generated by the <code>inputs</code> ports of the web-midi instance.</p>
        <code>
            var inputs = yourMidiAccessObject.inputs.values();<br />
            inputs[0].value.onmidimessage = onMidiMessageHandler;
        </code>
    </div>
    <div id="messages" class="gray-box"></div>

    <script>

        // No ES6 fancy features, because we try to remain compatible with http://www.taktech.org/takm/WebMIDIBrowser/Web_MIDI_Browser.html

        var W3CMidi = null;  // global MIDIAccess object

        function padZero(str, len, char) {
            let s = "";
            let c = char || "0";
            let n = (len || 2) - str.length;
            while (s.length < n) s += c;
            return s + str;
        }

        function h(v) {
            return (v === null || v === undefined) ? "" : padZero(v.toString(16).toUpperCase(), 2);
        }

        function hs(data) {
            return (data === null || data === undefined) ? "" : (Array.from(data).map(n => h(n))).join(" ");    // Array.from() is necessary to get a non-typed array
        }

        // print in reverse order
        function log(what, where) {
            var c = what.startsWith("(") ? "gray" : "";
            $(where).prepend("<span class=\"" + c + "\">[" + moment().format('HH:mm:ss.SSS') + "] " + what + "</span>\n");
        }

        function listInputsAndOutputs() {
            // console.log("listInputsAndOutputs");

            if (W3CMidi === null) return;

            $("#inputs").html("");
            $("#outputs").html("");

            let iter = W3CMidi.inputs.values();
            for (let o = iter.next(); !o.done; o = iter.next()) {
                let i = o.value;
                log("man: " + i.manufacturer + " name: " + i.name + " id: " + i.id, "#inputs");
                console.log("in", i.type, i.name, i.state, i.connection)
            }

            iter = W3CMidi.outputs.values();
            for (let o = iter.next(); !o.done; o = iter.next()) {
                let i = o.value;
                log("man: " + i.manufacturer + " name: " + i.name + " id: " + i.id, "#outputs");
                console.log("out", i.type, i.name, i.state, i.connection)
            }
        }

        function setInputListeners() {
            let inputs = W3CMidi.inputs.values();
            for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
                console.log(`setInputListeners: add onMidiMessageHandler for input "${input.value.name}"`);
                input.value.onmidimessage = onMidiMessageHandler;
            }
        }

        function onMidiMessageHandler(message) {
            console.log("onMidiMessageHandler", message);

            if (message instanceof MIDIMessageEvent) {
                let bytes = message.data;       // type is Uint8Array
                let channel = bytes[0] & 0x0F;  // MIDI channel
                let type = bytes[0] & 0xF0;     // MIDI event type
                let port = message.currentTarget;
                log(message.type + " data: [" + hs(bytes) + "] channel: " + channel + " source: " + port.name, "#messages");
            } else {
                log(message.type + ': ' + hs(message.data), "#messages");
            }
        }

        function onStateChangeHandler(e) {
            console.group("> onStateChangeHandler", e.port.type, e.port.name, e.port.state, e.port.connection);

            let p = e.port;
            log(p.type + ' "' + p.name + '" state changed to ' + p.state, "#events");
            if (p.state === "connected") {
                // Handle the connection
                if (p.type === "input") {
                    if (!p.onmidimessage) {
                        console.log("set onMidiMessageHandler");
                        p.onmidimessage = onMidiMessageHandler;
                        log('"' + p.name + '" input listener added', "#state");
                    }
                }
            } else if (p.state === "disconnected") {
                // Handle the disconnection
                if (p.type === "input") {
                    if (p.onmidimessage) {
                        console.log("remove onMidiMessageHandler");
                        p.onmidimessage = null;
                    }
                    log('"' + p.name + '" input listener removed', "#state");
                }
            } else {
                log(p.type + ' "' + p.name + '" is in an unknown state: ' + p.state , "#state");
            }
            listInputsAndOutputs();
            // console.log("- onStateChangeHandler");
            console.groupEnd();
        }

        function onMIDISuccess(midiAccess) {
            console.log("onMIDISuccess");

            log("Got access to MIDI", "#state");
            W3CMidi = midiAccess;
            listInputsAndOutputs();
            // setInputListeners();
            W3CMidi.onstatechange = onStateChangeHandler;
        }

        function onMIDIFailure(msg) {
            console.warn("Failed to get MIDI access", msg);
            log("Failed to get MIDI access. " + msg, "#state");
        }

        $(function () {

            console.log("start");

            $("#clear-all").click(function(){
                $("#events, #state, #inputs, #outputs, #messages").html("");
            });

            $("#toggle-help").click(function(){
                $(".help").toggle();
            });

            // if (navigator.requestMIDIAccess) {

                console.log("requestMIDIAccess is available");

                navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);

            // } else {
            //     log("ERROR: navigator.requestMIDIAccess not supported", "#state");
            // }

        });
    </script>
</body>
</html>
