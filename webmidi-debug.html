<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebMidi.js events</title>
    <meta name="author" content="https://github.com/francoisgeorgy">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/moment/moment/03073778/moment.js"></script>
<!--    <script src="https://rawgit.com/cotejp/webmidi/master/webmidi.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/webmidi@2.3.3"></script>
    <style>
        html {
            font-family: sans-serif;
        }
        .help {
            display: none;
        }
        #clear-all, #toggle-help {
            float: right;
            font-size: 1em;
            margin-left: 10px;
        }
        .gray-box {
            border: 1px solid #aaa;
            background-color: #f0f0f0;
            padding: 1rem;
            margin: 1rem;
            text-align: left;
        }
        .input-box {
            /*border: 1px solid #aaa;*/
            /*background-color: #f0f0f0;*/
            /*padding: 1rem;*/
            margin: 1rem;
            text-align: left;
        }
        .input-box input {
            padding: 0.5rem;
            color: #000;
            font-size: 1.25rem;
        }
        button {
            margin-left: 1rem;
            font-size: 1rem;
            color: #000;
        }
        #events, #state, #messages {
            font-family: monospace;
            white-space: pre;
        }
        .gray {
            color: #999;
        }
        .small {
            font-size: 0.8em;
        }
    </style>
</head>
<body>

    <button id="clear-all">clear all</button>
    <button id="toggle-help">toggle help</button>

    <h1>Web-MIDI events and messages with the WebMidi.js library</h1>

<!--    <div class="small"><a href="https://github.com/francoisgeorgy/web-midi-events" target="_blank" rel="noopener">https://github.com/francoisgeorgy/web-midi-events</a></div>-->

    <div class="help">
        <p>Use the latest version of the great WebMidi library available at <a href="https://github.com/djipco/webmidi" target="_blank" rel="noopener">https://github.com/djipco/webmidi</a>.</p>
        <p>The API is documented at <a href="http://djipco.github.io/webmidi/latest/classes/WebMidi.html" target="_blank" rel="noopener">http://djipco.github.io/webmidi/latest/classes/WebMidi.html</a>.</p>
    </div>

    <h3>Webmidi events:</h3>
    <p class="help">MIDI connections events and informative messages about what the application is doing.</p>
    <div id="state" class="gray-box"></div>

    <h3>Inputs (MIDI sources):</h3>
    <p class="help">Show the MIDI ports listed in the <code>inputs</code> attribute of the <code>WebMidi</code> object.</p>
    <ul id="inputs" class="xgray-box"></ul>

    <h3>Outputs (MIDI targets):</h3>
    <p class="help">Show the MIDI ports listed in the <code>outputs</code> attribute of the <code>WebMidi</code> object.</p>
    <ul id="outputs" class="xgray-box"></ul>

    <h3>Send message:</h3>
    <p class="help">Send any MIDI message.</p>
    <div id="data" class="input-box">
        <input id="data-hex" type="text" size="100" placeholder="bytes in hex format, example: f0 7e 00 06 01 f7"/>
    </div>
    <button id="send-message">send</button>

    <h3>MIDI messages received:</h3>
    <div class="help">
        <p>Show the messages events generated by the <code>inputs</code> ports of the <code>WebMidi</code> object.</p>
    </div>
    <div id="messages" class="gray-box"></div>

    <script>

        // id is a string
        function portById(id) {
            let p = WebMidi.inputs.find(item => item.id === id);
            if (p) {
                return p;
            } else {
                return WebMidi.outputs.find(item => item.id === id);
            }
        }

        // id is a string
        function outputById(id) {
            // console.log(WebMidi.outputs);
            return WebMidi.outputs.find(item => item.id === id);
        }

        function padZero(str, len, char) {
            let s = "";
            let c = char || "0";
            let n = (len || 2) - str.length;
            while (s.length < n) s += c;
            return s + str;
        }

        function h(v) {
            return (v === null || v === undefined) ? "" : padZero(v.toString(16).toUpperCase(), 2);
        }

        function hs(data) {
            return (data === null || data === undefined) ? "" : (Array.from(data).map(n => h(n))).join(" ");    // Array.from() is necessary to get a non-typed array
        }

        function fromHexString(string, sep) {
            console.log("fromHexString(string, sep)", string, sep);
            let s = sep ? string.replace(sep, '') : string;
            if ((s.length % 2) > 0) {
                // TODO: throw an exception
                console.warn(`fromHexString: invalid hex string: ${s}`);
                return null;
            }
            let a = new Uint8Array(s.length / 2);
            for (let i=0; i < (s.length / 2); i++) {
                a[i] = parseInt(s.substr(i * 2, 2), 16);
            }
            return a;
        }

        function info(what, where) {
            var c = what.startsWith("(") ? "gray" : "";
            $(where).append("<span class=\"" + c + "\">" + what + "</span>\n");
        }

        function list(what, where, id) {
            var c = what.startsWith("(") ? "gray" : "";
            $(where).append("<li class=\"" + c + "\"><input type='checkbox' name='port"+ id +"' value='1'>" + what + "</li>\n");
        }

        function log(what, where) {
            var c = what.startsWith("(") ? "gray" : "";
            $(where).append("<span class=\"" + c + "\">[" + moment().format('HH:mm:ss.SSS') + "] " + what + "</span>\n");
        }

        function connectionEventToString(event) {
            return `"${event.type}" event for ${event.port.type} ${event.port.name}, connection status is ${event.port.connection}`;
        }

        function inputMessageToString(message) {
            return `< ${message.target.name} : ${hs(message.data)}`;
            // return `< ${message.target.name} : [${hs(message.data)}] : ${message.type}`;
        }

        function logMidiMessage(message) {
            if ((typeof event === 'undefined') || (event === null)) {
                console.warn("logMidiMessage: null or undefined message received");
                return;
            }
            log(inputMessageToString(message), '#messages');
        }

        function logMidiMessageOut(bytes, id, sysex=false) {
            let s = hs(bytes);
            if (sysex) s = `F0 ${s} F7`;
            log(`> ${id} : ${s}`, '#messages');
        }

        function listInputsAndOutputs() {
            $("#inputs").html("");
            $("#outputs").html("");
            // WebMidi.inputs.map(function(i) { log(i.name + " - id " + i.id + " - connection state " + i.connection, "#inputs") });
            // WebMidi.outputs.map(function(i) { log(i.name + " - id " + i.id + " - connection state " + i.connection, "#outputs") });
            WebMidi.inputs.map(function(i) { list(i.name + " - id " + i.id + " - connection state " + i.connection, "#inputs", i.id) });
            WebMidi.outputs.map(function(i) { list(i.name + " - id " + i.id + " - connection state " + i.connection, "#outputs", i.id) });
        }

        // add a "midimessage" event listener to each input
        function addInputListeners() {
            WebMidi.inputs.map(function(i) {
                if (!i.hasListener("midimessage", "all", logMidiMessage)) {
                    i.addListener("midimessage", "all", logMidiMessage);
                    log(`${i.name} : input listener added on all channels`, "#state");
                } else {
                    console.log(`${i.name} : input listener already added`);
                }
            });
        }

        function removeInputListeners() {
            WebMidi.inputs.map(function(i) {
                i.removeListener();
                log(`${i.name} input listeners removed for all channels`, "#state");
            });
        }

        function onConnectionEvent(event) {

            if ((typeof event === 'undefined') || (event === null)) {
                console.warn("logMidiEvent: null or undefined event received");
                return;
            }
            log(connectionEventToString(event), '#state');

            // if (event.port.connection === "open") {
            //     log(`${event.port.type} ${event.port.name} connection state is now open`, "#state");
            // } //else {

            if (event.port.type === 'input') {
                if (event.type === "connected") {
                    addInputListeners();
                }
                if (event.type === "disconnected") {
                    removeInputListeners();
                }
            }

            listInputsAndOutputs();
        }

        $(function() {

            $("#clear-all").click(function(){
                $("#events, #state, #inputs, #outputs, #messages").html("");
            });

            $("#toggle-help").click(function(){
                $(".help").toggle();
            });

            $("#send-message").click(function(){
                const dataString = $("#data-hex").val();
                const a = fromHexString(dataString, ' ');
                // console.log(dataString, a);

                const ports = $("#outputs li input:checked");
                ports.each(function(index) {
                    const id = $(this).attr("name").substr(4);
                    const port = outputById(id);
                    console.log($(this).attr("name"), id, port);
                    // const bytes = [0x7E, 0x00, 0x06];
                    // port.sendSysex(bytes, [0x01]);  // use sendSysex to bypass the webmidijs internal checks.
                    const bytes = [0x7E, 0x00, 0x06, 0x01];
                    logMidiMessageOut(bytes, port.name, true);
                    port.sendSysex(bytes[0], bytes.slice(1));  // use sendSysex to bypass the webmidijs internal checks.
                });


                // out.sendSysex([0x7E, 0x00, 0x06], [0x01]);  // use sendSysex to bypass the webmidijs internal checks.

            });

            WebMidi.enable(function (err) {
                if (err) {
                    console.warn("WebMidi could not be enabled", err);
                    log("ERROR: " + err.message, "#state");
                    return;
                }
                log("Got access to MIDI", "#state");
                WebMidi.addListener("connected", onConnectionEvent);
                WebMidi.addListener("disconnected", onConnectionEvent);
                listInputsAndOutputs();
            }, true);

        });

    </script>
</body>
</html>
